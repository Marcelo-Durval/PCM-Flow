<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGP v18 - Filtros Avan√ßados</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pocketbase/0.21.1/pocketbase.umd.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #0f172a; --secondary: #64748b; --accent: #2563eb;
            --bg: #f8fafc; --white: #ffffff;
            --sidebar-width: 250px;
            --danger: #ef4444; --warning: #f59e0b; --success: #10b981;
            --input-bg: #f9fafb; --border: #e2e8f0;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; color: #1e293b; }
        
        /* LAYOUT & SIDEBAR */
        .sidebar { width: var(--sidebar-width); background: var(--primary); color: white; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; }
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .content-scroll { padding: 30px; overflow-y: auto; flex: 1; }
        .hidden { display: none !important; }
        .brand { font-size: 1.5rem; font-weight: 700; margin-bottom: 30px; display: flex; align-items: center; gap: 10px; }
        .menu-item { padding: 12px 15px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 12px; color: #94a3b8; transition: 0.2s; font-weight: 500; }
        .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.15); color: white; }

        /* DASHBOARD GRID */
        .dash-kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; position: relative; overflow: hidden; }
        .kpi-title { font-size: 0.85rem; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .kpi-value { font-size: 2rem; font-weight: 700; color: var(--primary); margin-top: 5px; }
        .kpi-icon { position: absolute; right: -10px; bottom: -10px; font-size: 4rem; opacity: 0.05; color: var(--primary); transform: rotate(-15deg); }
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .chart-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        .chart-header { margin-bottom: 15px; font-weight: 600; color: var(--primary); font-size: 1rem; }

        /* TABELAS & FILTROS */
        .filter-bar { display: flex; gap: 10px; align-items: center; background: white; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-input { padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.9rem; min-width: 150px; }
        .data-table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); font-size: 0.9rem; }
        .data-table th { background: #f1f5f9; text-align: left; padding: 12px 15px; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0; }
        .data-table td { padding: 12px 15px; border-bottom: 1px solid #e2e8f0; vertical-align: middle; }
        .data-table tr:hover { background: #f8fafc; }
        
        /* STATUS & BADGES */
        .status-select { padding: 6px 10px; border-radius: 20px; border: 1px solid #e2e8f0; font-size: 0.8rem; font-weight: 600; cursor: pointer; }
        .st-cotacao { background: #fff7ed; color: #ea580c; border-color: #fdba74; }
        .st-aprovacao { background: #eff6ff; color: #2563eb; border-color: #bfdbfe; }
        .st-entregue { background: #f0fdf4; color: #16a34a; border-color: #86efac; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; display: inline-block; }
        .bd-Alta { background: #fee2e2; color: #991b1b; }
        .bd-M√©dia { background: #fef3c7; color: #92400e; }
        .bd-Baixa { background: #dcfce7; color: #166534; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); z-index: 2000; display: flex; justify-content: center; align-items: center; }
        .modal-box { background: white; width: 100%; max-width: 1000px; height: 90vh; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        .modal-header { padding: 25px; border-bottom: 1px solid #e2e8f0; background: #fff; display: flex; justify-content: space-between; align-items: flex-start; gap: 20px; }
        .modal-body { display: flex; flex: 1; overflow: hidden; }
        .modal-left { flex: 2; padding: 25px; overflow-y: auto; border-right: 1px solid #e2e8f0; }
        .modal-right { flex: 1; display: flex; flex-direction: column; background: #f8fafc; min-width: 320px;}

        /* CHAT */
        .chat-container { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .chat-bubble { padding: 10px; border-radius: 8px; font-size: 0.85rem; max-width: 90%; word-wrap: break-word; }
        .chat-sistema { background: #e2e8f0; color: #64748b; align-self: center; font-size: 0.75rem; border: 1px solid #cbd5e1; text-align: center; padding: 4px 10px;}
        .chat-user { background: white; border: 1px solid #e2e8f0; align-self: flex-start; }
        .chat-me { background: #dbeafe; border: 1px solid #bfdbfe; align-self: flex-end; color: #1e40af; }
        .chat-meta { font-size: 0.7rem; color: #94a3b8; margin-bottom: 2px; font-weight: 600; }
        .chat-input-area { padding: 15px; border-top: 1px solid #e2e8f0; display: flex; gap: 10px; background: white; }

        /* FORMUL√ÅRIOS & UTILS */
        .form-group { margin-bottom: 15px; }
        .form-label { font-size: 0.85rem; color: #475569; font-weight: 600; display: block; margin-bottom: 6px; }
        .form-control { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); font-size: 0.95rem; color: #334155; transition: all 0.2s; box-sizing: border-box; }
        .form-control:focus { outline: none; border-color: var(--accent); background: white; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .btn { padding: 10px 18px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 0.9rem; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-outline { background: transparent; border: 1px solid #cbd5e1; color: var(--secondary); }
        .btn-outline:hover { background: #f1f5f9; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
        .input-sm { padding: 6px; font-size: 0.85rem; border-radius: 4px; background: white; }
        .label-sm { font-size: 0.75rem; color: #64748b; font-weight: 600; margin-bottom: 3px; display: block;}
        
        /* HEADER BAR */
        .top-bar { background: white; height: 60px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: flex-end; align-items: center; padding: 0 30px; gap: 20px; }
        .notif-wrapper { position: relative; cursor: pointer; }
        .badge-count { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; font-size: 0.7rem; font-weight: bold; padding: 2px 6px; border-radius: 10px; display: none; }
        .notif-dropdown { position: absolute; top: 40px; right: 0; width: 320px; background: white; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); z-index: 3000; display: none; max-height: 400px; overflow-y: auto; }
        .notif-item { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; font-size: 0.85rem; color: #334155; }
        
        #toast-container { position: fixed; top: 80px; right: 30px; z-index: 4000; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-left: 4px solid var(--accent); width: 300px; animation: slideIn 0.3s ease-out; font-size: 0.9rem; }
        .file-drop { border: 2px dashed #cbd5e1; padding: 20px; text-align: center; border-radius: 8px; cursor: pointer; background: #f8fafc; color: #64748b; transition: 0.2s; }
        .file-drop:hover { border-color: var(--accent); background: #eff6ff; color: var(--accent); }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div id="login-screen" class="modal-overlay">
        <div class="modal-box" style="max-width: 400px; height: auto; text-align: center; padding: 40px;">
            <h2 style="color: var(--primary); margin-top:0;">üîê Acesso SGP</h2>
            <div style="margin-bottom:15px"><input type="email" id="email" class="form-control" placeholder="Email"></div>
            <div style="margin-bottom:15px"><input type="password" id="password" class="form-control" placeholder="Senha"></div>
            <button onclick="fazerLogin()" class="btn btn-primary" style="width: 100%;">ENTRAR</button>
        </div>
    </div>

    <div class="sidebar hidden" id="sidebar">
        <div class="brand">‚öôÔ∏è SGP <span style="font-size:0.6em; background:#334155; padding:2px 6px; border-radius:4px;">PRO</span></div>
        <div class="menu-item active" id="menu-dashboard" onclick="navegar('dashboard')"><span>üìä</span> Dashboard</div>
        <div class="menu-item" id="menu-manutencao" onclick="navegar('manutencao')"><span>üîß</span> Manuten√ß√£o</div>
        <div class="menu-item" id="menu-compras" onclick="navegar('compras')"><span>üõí</span> Compras</div>
        <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
            <div style="font-size: 0.85rem; margin-bottom: 10px; color: #cbd5e1;" id="user-display">...</div>
            <button onclick="logout()" class="btn btn-outline" style="width:100%; border-color: rgba(255,255,255,0.2); color:white;">Sair</button>
        </div>
    </div>

    <div class="main-content hidden" id="main-app">
        <div class="top-bar">
            <div class="notif-wrapper" onclick="toggleNotificacoes()">
                <div class="bell-icon">üîî</div>
                <div class="badge-count" id="notif-badge">0</div>
                <div class="notif-dropdown" id="notif-list">
                    <div style="padding:10px; border-bottom:1px solid #eee; font-weight:600;">Notifica√ß√µes <span style="font-size:0.7em; color:blue; cursor:pointer; float:right;" onclick="limparNotif(event)">Limpar</span></div>
                    <div id="notif-items-container"></div>
                </div>
            </div>
        </div>

        <div class="content-scroll">
            
            <div id="view-dashboard">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2 style="margin:0; color: var(--primary);">Vis√£o Geral</h2>
                    <button onclick="carregarDashboard()" class="btn btn-sm btn-outline">üîÑ Atualizar</button>
                </div>
                <div class="dash-kpi-grid">
                    <div class="kpi-card"><div class="kpi-title">OS em Aberto</div><div class="kpi-value" id="kpi-os-aberta">0</div><div class="kpi-icon">üîß</div></div>
                    <div class="kpi-card"><div class="kpi-title">Itens p/ Comprar</div><div class="kpi-value" id="kpi-itens-pend">0</div><div class="kpi-icon">üõí</div></div>
                    <div class="kpi-card"><div class="kpi-title">Valor Estimado (R$)</div><div class="kpi-value" id="kpi-valor-total" style="color:var(--success)">0</div><div class="kpi-icon">üí≤</div></div>
                    <div class="kpi-card"><div class="kpi-title">Urg√™ncia Alta</div><div class="kpi-value" id="kpi-urgencia-alta" style="color:var(--danger)">0</div><div class="kpi-icon">üî•</div></div>
                </div>
                <div class="charts-grid">
                    <div class="chart-card"><div class="chart-header">Status dos Materiais</div><canvas id="chartStatus"></canvas></div>
                    <div class="chart-card"><div class="chart-header">Envelhecimento (Dias)</div><canvas id="chartAging"></canvas></div>
                    <div class="chart-card"><div class="chart-header">Materiais por Urg√™ncia</div><canvas id="chartUrgencia"></canvas></div>
                </div>
            </div>

            <div id="view-manutencao" class="hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2 style="margin:0; color: var(--primary);">Solicita√ß√µes</h2>
                    <button onclick="abrirModalCriacao()" class="btn btn-primary">+ Nova</button>
                </div>
                
                <div class="filter-bar">
                    <span>üîç</span>
                    <input type="text" id="busca-manut" placeholder="Buscar texto..." class="filter-input" onkeyup="aplicarFiltrosManutencao()">
                    <select id="filtro-manut-cat" class="filter-input" onchange="aplicarFiltrosManutencao()">
                        <option value="">Todas Categorias</option>
                        <option value="M√°quina parada">M√°quina parada</option>
                        <option value="Seguran√ßa">Seguran√ßa</option>
                        <option value="Qualidade">Qualidade</option>
                        <option value="Estoque">Estoque</option>
                    </select>
                    <select id="filtro-manut-urg" class="filter-input" onchange="aplicarFiltrosManutencao()">
                        <option value="">Todas Urg√™ncias</option>
                        <option value="Alta">Alta</option>
                        <option value="M√©dia">M√©dia</option>
                        <option value="Baixa">Baixa</option>
                    </select>
                </div>

                <table class="data-table">
                    <thead><tr><th width="30">#</th><th>N¬∫ OS</th><th>Problema</th><th>Categoria</th><th>Urg√™ncia</th><th>Data</th><th>A√ß√£o</th></tr></thead>
                    <tbody id="tabela-manutencao"></tbody>
                </table>
            </div>

            <div id="view-compras" class="hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2 style="margin:0; color: var(--primary);">Gest√£o de Materiais</h2>
                </div>

                <div class="filter-bar">
                    <span>üîç</span>
                    <input type="text" id="busca-compra" placeholder="Buscar item, OS, SC..." class="filter-input" onkeyup="aplicarFiltrosCompras()">
                    <select id="filtro-compra-status" class="filter-input" onchange="aplicarFiltrosCompras()">
                        <option value="">Todos Status</option>
                        <option value="Em cota√ß√£o">Em cota√ß√£o</option>
                        <option value="Aguardando aprova√ß√£o">Aguardando aprova√ß√£o</option>
                        <option value="Aguardando entrega">Aguardando entrega</option>
                        <option value="Entregue">Entregue</option>
                        <option value="Cancelado">Cancelado</option>
                    </select>
                    <select id="filtro-compra-urg" class="filter-input" onchange="aplicarFiltrosCompras()">
                        <option value="">Todas Urg√™ncias</option>
                        <option value="Alta">Alta</option>
                        <option value="M√©dia">M√©dia</option>
                        <option value="Baixa">Baixa</option>
                    </select>
                </div>

                <table class="data-table">
                    <thead><tr><th width="150">Status</th><th>Item</th><th width="50">Qtd</th><th>Urg√™ncia (Item)</th><th>Origem (OS / SC)</th><th>A√ß√£o</th></tr></thead>
                    <tbody id="tabela-compras"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modal-detalhes" class="modal-overlay hidden">
        <div class="modal-box">
            <div class="modal-header">
                <div style="flex:1;">
                    <div class="form-group"><span class="label-sm">T√≠tulo</span><input type="text" id="edit-titulo" class="form-control" style="font-weight:bold;"></div>
                    <div class="form-group"><span class="label-sm">Descri√ß√£o</span><textarea id="edit-descricao" class="form-control" rows="2"></textarea></div>
                    <div style="display:flex; gap:15px;">
                        <div style="flex:1"><span class="label-sm" style="color:var(--accent)">OS (Atlas)</span><input type="text" id="edit-os" class="form-control"></div>
                        <div style="flex:1"><span class="label-sm" style="color:#e11d48">SC (Pir√¢mide)</span><input type="text" id="edit-sc" class="form-control"></div>
                        <div style="flex:1"><span class="label-sm">Categoria</span><select id="edit-categoria" class="form-control"><option>M√°quina parada</option><option>Seguran√ßa</option><option>Qualidade</option><option>Estoque</option></select></div>
                        <div style="flex:1"><span class="label-sm">Urg√™ncia</span><select id="edit-urgencia" class="form-control"><option>Alta</option><option>M√©dia</option><option>Baixa</option></select></div>
                    </div>
                </div>
                <div style="display:flex; flex-direction:column; gap:10px; align-items:flex-end; min-width: 120px;">
                    <button onclick="fecharDetalhes()" style="border:none; background:none; font-size:2rem; cursor:pointer; line-height:1; color:#94a3b8;">&times;</button>
                    <button onclick="atualizarDadosPrincipais()" class="btn btn-success btn-sm" style="margin-top:auto;">üíæ Salvar</button>
                </div>
            </div>
            <div class="modal-body">
                <div class="modal-left">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h4 style="margin:0; color:var(--primary);">üìã Lista de Materiais</h4>
                        <button onclick="abrirModalImportacao()" class="btn btn-outline btn-sm" style="color:#16a34a; border-color:#16a34a;">üìó Importar Excel</button>
                    </div>
                    <div style="background:#f0f9ff; padding:15px; border-radius:8px; border:1px dashed #bae6fd; margin-bottom:20px; display:flex; gap:10px; align-items: flex-end;">
                        <div style="flex:2"><span class="label-sm" style="color:#0369a1;">Novo Item</span><input type="text" id="mat-nome" class="form-control" style="margin:0;"></div>
                        <div style="flex:1"><span class="label-sm" style="color:#0369a1;">Qtd</span><input type="number" id="mat-qtd" class="form-control" style="margin:0;"></div>
                        <div style="flex:1"><span class="label-sm" style="color:#0369a1;">Urg√™ncia</span><select id="mat-urg" class="form-control" style="margin:0;"><option value="Baixa">Baixa</option><option value="M√©dia">M√©dia</option><option value="Alta">Alta</option></select></div>
                        <button onclick="adicionarMaterial()" class="btn btn-primary" style="height: 42px;">+</button>
                    </div>
                    <div id="lista-materiais-modal">Carregando...</div>
                </div>
                <div class="modal-right">
                    <div style="padding:15px; border-bottom:1px solid #e2e8f0; font-weight:600; font-size:0.95rem; color:var(--primary);">üí¨ Hist√≥rico & Obs</div>
                    <div class="chat-container" id="chat-feed"></div>
                    <div class="chat-input-area">
                        <input type="text" id="chat-msg" placeholder="Digite uma mensagem..." class="form-control" style="margin:0;">
                        <button onclick="enviarComentario()" id="btn-send-chat" class="btn btn-primary btn-sm">‚û§</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-criacao" class="modal-overlay hidden">
        <div class="modal-box" style="height:auto; max-width:600px; padding: 30px;">
            <h3 style="margin-top:0; color:var(--primary); margin-bottom: 20px;">Nova Solicita√ß√£o</h3>
            <div style="margin-bottom:15px"><label class="label-sm">T√≠tulo</label><input type="text" id="inp-titulo" class="form-control"></div>
            <div style="margin-bottom:15px"><label class="label-sm">Descri√ß√£o</label><textarea id="inp-descricao" class="form-control"></textarea></div>
            <div style="display:flex; gap:20px; margin-bottom:15px;">
                <div style="flex:1"><label class="label-sm" style="color:var(--accent)">N¬∫ OS (Atlas)</label><input type="text" id="inp-os" class="form-control"></div>
                <div style="flex:1"><label class="label-sm" style="color:#e11d48">N¬∫ SC (Pir√¢mide)</label><input type="text" id="inp-sc" class="form-control"></div>
            </div>
            <div style="display:flex; gap:20px; margin-bottom:15px;">
                <div style="flex:1"><label class="label-sm">Categoria</label><select id="inp-categoria" class="form-control"><option>M√°quina parada</option><option>Seguran√ßa</option><option>Qualidade</option><option>Estoque</option></select></div>
                <div style="flex:1"><label class="label-sm">Urg√™ncia</label><select id="inp-urgencia" class="form-control"><option>Alta</option><option>M√©dia</option><option>Baixa</option></select></div>
            </div>
            <div style="margin-bottom:15px"><label class="label-sm">Respons√°vel</label><select id="inp-responsavel" class="form-control"></select></div>
            <div style="text-align:right; margin-top:30px;">
                <button onclick="document.getElementById('modal-criacao').classList.add('hidden')" class="btn btn-outline">Cancelar</button>
                <button onclick="salvarSolicitacao()" class="btn btn-primary">Criar Solicita√ß√£o</button>
            </div>
        </div>
    </div>

    <div id="modal-importacao" class="modal-overlay hidden" style="z-index: 2500;">
        <div class="modal-box" style="height:auto; max-width:500px; padding:30px;">
            <h3 style="margin-top:0;">Importar Lista do Excel</h3>
            <div id="step-upload">
                <input type="file" id="input-excel" accept=".xlsx, .xls, .csv" style="display:none" onchange="lerArquivoExcel(this)">
                <div class="file-drop" onclick="document.getElementById('input-excel').click()">üìÇ Selecionar arquivo</div>
            </div>
            <div id="step-mapping" class="hidden" style="margin-top:20px;">
                <div style="margin-bottom:15px"><label class="label-sm">Coluna DESCRI√á√ÉO</label><select id="map-desc" class="form-control"></select></div>
                <div style="margin-bottom:15px"><label class="label-sm">Coluna QUANTIDADE</label><select id="map-qtd" class="form-control"></select></div>
                <div style="margin-bottom:15px"><label class="label-sm">Urg√™ncia Padr√£o</label><select id="map-urg" class="form-control"><option value="Baixa">Baixa</option><option value="M√©dia">M√©dia</option><option value="Alta">Alta</option></select></div>
                <div style="text-align:right;">
                    <button onclick="fecharModalImportacao()" class="btn btn-outline">Cancelar</button>
                    <button onclick="executarImportacao()" class="btn btn-success">Importar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const pb = new PocketBase('/');
        let ACAO_ATUAL_ID = null;
        let IMPORT_DATA = null;
        let NOTIF_COUNT = 0;
        let CHART_INSTANCES = {};

        // AUTH & INIT
        async function fazerLogin() { try { await pb.collection('users').authWithPassword(document.getElementById('email').value, document.getElementById('password').value); checkAuth(); } catch(e){ alert("Erro login"); } }
        function logout() { pb.authStore.clear(); checkAuth(); }
        
        function checkAuth() {
            if(pb.authStore.isValid) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('sidebar').classList.remove('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('user-display').innerText = pb.authStore.model.name;
                
                const perfil = pb.authStore.model.perfil || 'admin';
                if(perfil === 'operador') {
                    document.getElementById('menu-manutencao').classList.add('hidden');
                    navegar('compras'); 
                } else {
                    document.getElementById('menu-manutencao').classList.remove('hidden');
                    navegar('dashboard'); 
                }

                carregarUsuarios(); iniciarRealtime();
                document.getElementById('chat-msg').addEventListener('keydown', function(e) { if (e.key === 'Enter') enviarComentario(); });
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('sidebar').classList.add('hidden');
                document.getElementById('main-app').classList.add('hidden');
            }
        }

        function navegar(tela) {
            document.querySelectorAll('.menu-item').forEach(i=>i.classList.remove('active'));
            document.getElementById('menu-'+tela).classList.add('active');
            ['dashboard','manutencao','compras'].forEach(t => document.getElementById('view-'+t).classList.add('hidden'));
            document.getElementById('view-'+tela).classList.remove('hidden');
            if(tela==='dashboard') carregarDashboard();
            if(tela==='manutencao') carregarManutencao();
            if(tela==='compras') carregarCompras();
        }

        // --- DASHBOARD ---
        async function carregarDashboard() {
            const acoes = await pb.collection('acoes').getFullList();
            const materiais = await pb.collection('materiais').getFullList();

            // KPIs
            const osAbertas = acoes.filter(a => a.status !== 'Conclu√≠do').length;
            const matPendentes = materiais.filter(m => m.status_compra !== 'Entregue' && m.status_compra !== 'Cancelado').length;
            const urgAlta = materiais.filter(m => m.urgencia_material === 'Alta' && m.status_compra !== 'Entregue').length;
            const valorTotal = materiais.reduce((acc, m) => acc + ((m.valor || 0) * (m.quantidade || 0)), 0);

            document.getElementById('kpi-os-aberta').innerText = osAbertas;
            document.getElementById('kpi-itens-pend').innerText = matPendentes;
            document.getElementById('kpi-urgencia-alta').innerText = urgAlta;
            document.getElementById('kpi-valor-total').innerText = valorTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2});

            // Gr√°ficos
            const statusCount = {}; materiais.forEach(m => { statusCount[m.status_compra] = (statusCount[m.status_compra] || 0) + 1; });
            const urgCount = { 'Alta': 0, 'M√©dia': 0, 'Baixa': 0 }; materiais.forEach(m => { if(urgCount[m.urgencia_material] !== undefined) urgCount[m.urgencia_material]++; });
            
            const aging = { '0-7 dias': 0, '7-15 dias': 0, '15-30 dias': 0, '+30 dias': 0 };
            const now = new Date();
            materiais.forEach(m => {
                if(m.status_compra === 'Entregue' || m.status_compra === 'Cancelado') return;
                const diffDays = Math.ceil(Math.abs(now - new Date(m.created)) / (1000 * 60 * 60 * 24)); 
                if(diffDays <= 7) aging['0-7 dias']++;
                else if(diffDays <= 15) aging['7-15 dias']++;
                else if(diffDays <= 30) aging['15-30 dias']++;
                else aging['+30 dias']++;
            });

            renderChart('chartStatus', 'doughnut', Object.keys(statusCount), Object.values(statusCount), ['#f59e0b', '#3b82f6', '#10b981', '#ef4444', '#64748b']);
            renderChart('chartUrgencia', 'bar', Object.keys(urgCount), Object.values(urgCount), ['#ef4444', '#f59e0b', '#10b981']);
            renderChart('chartAging', 'line', Object.keys(aging), Object.values(aging), '#6366f1');
        }

        function renderChart(canvasId, type, labels, data, colors) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if(CHART_INSTANCES[canvasId]) CHART_INSTANCES[canvasId].destroy();
            CHART_INSTANCES[canvasId] = new Chart(ctx, {
                type: type,
                data: { labels: labels, datasets: [{ label: 'Qtd', data: data, backgroundColor: colors, borderColor: type==='line'?colors:'#fff', borderWidth: 2, tension:0.3, fill:type==='line' }] },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });
        }

        // --- MANUTEN√á√ÉO + FILTRO ---
        async function carregarManutencao() {
            const tb = document.getElementById('tabela-manutencao'); tb.innerHTML = '<tr><td colspan="7">Carregando...</td></tr>';
            try {
                const recs = await pb.collection('acoes').getFullList({sort:'-created', expand:'responsavel'});
                tb.innerHTML = '';
                recs.forEach(r => {
                    const cor = r.status==='Conclu√≠do'?'#10b981':'#f59e0b';
                    const osNum = r.ordem_servico ? `<b style="color:var(--accent)">OS ${r.ordem_servico}</b>` : '<span style="color:#ccc">S/ OS</span>';
                    // ADICIONADO DATA ATTRIBUTES PARA FILTRO
                    tb.innerHTML += `<tr data-cat="${r.categoria}" data-urg="${r.urgencia}">
                        <td><div style="width:10px; height:10px; background:${cor}; border-radius:50%;"></div></td>
                        <td>${osNum}</td>
                        <td><b>${r.titulo}</b></td>
                        <td>${r.categoria}</td>
                        <td><span class="badge bd-${r.urgencia}">${r.urgencia}</span></td>
                        <td>${new Date(r.created).toLocaleDateString()}</td>
                        <td><button class="btn btn-sm btn-outline" onclick="abrirDetalhes('${r.id}')">Ver Detalhes</button></td>
                    </tr>`;
                });
                aplicarFiltrosManutencao(); // Reaplica se tiver filtro selecionado
            } catch(e) {}
        }

        function aplicarFiltrosManutencao() {
            const txt = document.getElementById('busca-manut').value.toLowerCase();
            const cat = document.getElementById('filtro-manut-cat').value;
            const urg = document.getElementById('filtro-manut-urg').value;
            
            document.querySelectorAll('#tabela-manutencao tr').forEach(tr => {
                const rowText = tr.innerText.toLowerCase();
                const rowCat = tr.getAttribute('data-cat');
                const rowUrg = tr.getAttribute('data-urg');
                
                const matchTxt = rowText.includes(txt);
                const matchCat = cat === "" || rowCat === cat;
                const matchUrg = urg === "" || rowUrg === urg;

                tr.style.display = (matchTxt && matchCat && matchUrg) ? '' : 'none';
            });
        }

        // --- COMPRAS + FILTRO ---
        async function carregarCompras() {
            const tb = document.getElementById('tabela-compras'); tb.innerHTML = '<tr><td colspan="6">Carregando...</td></tr>';
            try {
                const mats = await pb.collection('materiais').getFullList({sort:'-created', expand:'acao_vinculada'});
                tb.innerHTML = '';
                mats.forEach(m => {
                    let cls = 'st-cotacao';
                    if(m.status_compra.includes('provad')) cls = 'st-aprovacao';
                    if(m.status_compra.includes('ntregue')) cls = 'st-entregue';
                    const os = m.expand?.acao_vinculada?.ordem_servico ? `<br><span style="color:var(--accent); font-size:0.8em">OS: ${m.expand?.acao_vinculada?.ordem_servico}</span>` : '';
                    const sc = m.expand?.acao_vinculada?.numero_sc ? `<span style="color:#e11d48; font-size:0.8em; margin-left:5px;">SC: ${m.expand?.acao_vinculada?.numero_sc}</span>` : '';
                    const btnHtml = m.acao_vinculada ? `<button class="btn btn-sm btn-outline" onclick="abrirDetalhes('${m.acao_vinculada}')">Ver SC</button>` : `<span style="color:#aaa">Sem v√≠nculo</span>`;

                    // ADICIONADO DATA ATTRIBUTES PARA FILTRO
                    tb.innerHTML += `<tr data-status="${m.status_compra}" data-urg="${m.urgencia_material}">
                        <td><select class="status-select ${cls}" onchange="mudarStatusMat('${m.id}', this.value, '${m.acao_vinculada}', '${m.descricao}')">
                            <option value="Em cota√ß√£o" ${m.status_compra=='Em cota√ß√£o'?'selected':''}>Em cota√ß√£o</option>
                            <option value="Aguardando aprova√ß√£o" ${m.status_compra=='Aguardando aprova√ß√£o'?'selected':''}>Ag. Aprova√ß√£o</option>
                            <option value="Aguardando entrega" ${m.status_compra=='Aguardando entrega'?'selected':''}>Ag. Entrega</option>
                            <option value="Entregue" ${m.status_compra=='Entregue'?'selected':''}>Entregue</option>
                            <option value="Cancelado" ${m.status_compra=='Cancelado'?'selected':''}>Cancelado</option>
                        </select></td>
                        <td><b>${m.descricao}</b><br><small style="color:blue">AF: ${m.num_af||'-'} | R$: ${m.valor||'0'} | Data: ${formatDate(m.data_entrega)}</small></td>
                        <td>${m.quantidade}</td>
                        <td><span class="badge bd-${m.urgencia_material}">${m.urgencia_material}</span></td>
                        <td><b>${m.expand?.acao_vinculada?.titulo || '-'}</b>${os}${sc}</td>
                        <td>${btnHtml}</td>
                    </tr>`;
                });
                aplicarFiltrosCompras(); // Reaplica
            } catch(e) {}
        }

        function aplicarFiltrosCompras() {
            const txt = document.getElementById('busca-compra').value.toLowerCase();
            const status = document.getElementById('filtro-compra-status').value;
            const urg = document.getElementById('filtro-compra-urg').value;
            
            document.querySelectorAll('#tabela-compras tr').forEach(tr => {
                const rowText = tr.innerText.toLowerCase();
                const rowStatus = tr.getAttribute('data-status');
                const rowUrg = tr.getAttribute('data-urg');
                
                const matchTxt = rowText.includes(txt);
                const matchStatus = status === "" || rowStatus === status;
                const matchUrg = urg === "" || rowUrg === urg;

                tr.style.display = (matchTxt && matchStatus && matchUrg) ? '' : 'none';
            });
        }

        // --- OUTRAS FUN√á√ïES (MANTIDAS) ---
        async function mudarStatusMat(id, st, acaoId, desc) {
            await pb.collection('materiais').update(id, {status_compra:st});
            if(acaoId) await registrarHistorico(acaoId, `Status de "${desc}" alterado para: ${st}`, "sistema");
            carregarCompras();
        }
        function abrirModalCriacao() { document.getElementById('modal-criacao').classList.remove('hidden'); }
        async function salvarSolicitacao() {
            const data = {
                titulo: document.getElementById('inp-titulo').value, descricao: document.getElementById('inp-descricao').value,
                ordem_servico: document.getElementById('inp-os').value, numero_sc: document.getElementById('inp-sc').value,     
                categoria: document.getElementById('inp-categoria').value, urgencia: document.getElementById('inp-urgencia').value,
                responsavel: document.getElementById('inp-responsavel').value, status: 'Aberto'
            };
            try {
                const novo = await pb.collection('acoes').create(data);
                await registrarHistorico(novo.id, "Solicita√ß√£o criada", "sistema");
                document.getElementById('modal-criacao').classList.add('hidden');
                abrirDetalhes(novo.id);
                registrarNotificacao(`Nova OS criada: ${data.titulo}`);
            } catch(e) { alert("Erro: " + e.message); }
        }
        async function abrirDetalhes(id) {
            if(!id) return;
            ACAO_ATUAL_ID = id;
            document.getElementById('modal-detalhes').classList.remove('hidden');
            const r = await pb.collection('acoes').getOne(id, {expand:'responsavel'});
            document.getElementById('edit-titulo').value = r.titulo;
            document.getElementById('edit-descricao').value = r.descricao;
            document.getElementById('edit-os').value = r.ordem_servico || '';
            document.getElementById('edit-sc').value = r.numero_sc || '';
            document.getElementById('edit-categoria').value = r.categoria;
            document.getElementById('edit-urgencia').value = r.urgencia;
            renderMateriais(id);
            renderHistorico(id);
        }
        function fecharDetalhes() { document.getElementById('modal-detalhes').classList.add('hidden'); ACAO_ATUAL_ID = null; if(!document.getElementById('view-manutencao').classList.contains('hidden')) carregarManutencao(); }
        async function renderMateriais(id) {
            const div = document.getElementById('lista-materiais-modal'); div.innerHTML = '...';
            const mats = await pb.collection('materiais').getFullList({filter:`acao_vinculada="${id}"`, sort:'-created'});
            div.innerHTML = '';
            mats.forEach(m => {
                const bg = m.status_compra==='Entregue' ? '#f0fdf4' : 'white';
                const dataValue = m.data_entrega ? m.data_entrega.substring(0, 10) : '';
                div.innerHTML += `
                    <div style="background:${bg}; border:1px solid #e2e8f0; border-radius:6px; padding:15px; margin-bottom:10px; box-shadow:0 1px 2px rgba(0,0,0,0.05);">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <div style="font-weight:600; color:var(--primary); font-size:1rem;">${m.descricao} <span style="font-weight:400; color:#64748b; font-size:0.9rem;">(Qtd: ${m.quantidade})</span> <span class="badge bd-${m.urgencia_material}" style="font-size:0.7em; margin-left:5px;">${m.urgencia_material}</span></div>
                            <div style="font-size:0.8rem; padding:2px 8px; background:#f1f5f9; border-radius:4px; color:#475569;">${m.status_compra}</div>
                        </div>
                        <div style="display:flex; gap:10px; background:#f8fafc; padding:8px; border-radius:6px;">
                            <div style="flex:1"><span class="label-sm">AF / Pedido</span><input type="text" class="form-control input-sm" value="${m.num_af||''}" onchange="updateMatData('${m.id}', 'num_af', this.value, 'AF')"></div>
                            <div style="flex:1"><span class="label-sm">Valor (R$)</span><input type="number" class="form-control input-sm" value="${m.valor||''}" onchange="updateMatData('${m.id}', 'valor', this.value, 'Valor')"></div>
                            <div style="flex:1"><span class="label-sm">Previs√£o</span><input type="date" class="form-control input-sm" value="${dataValue}" onchange="updateMatData('${m.id}', 'data_entrega', this.value, 'Data de Entrega')"></div>
                        </div>
                    </div>`;
            });
        }
        async function updateMatData(id, field, val, label) { try { const data = {}; data[field] = val; await pb.collection('materiais').update(id, data); await registrarHistorico(ACAO_ATUAL_ID, `Alterou ${label} para: ${val}`, "sistema"); renderMateriais(ACAO_ATUAL_ID); } catch(e) {} }
        async function adicionarMaterial() {
            if(!ACAO_ATUAL_ID) return;
            const nome = document.getElementById('mat-nome').value;
            if(!nome) return;
            await pb.collection('materiais').create({
                acao_vinculada: ACAO_ATUAL_ID, descricao: nome, quantidade: document.getElementById('mat-qtd').value, urgencia_material: document.getElementById('mat-urg').value, status_compra: 'Em cota√ß√£o'
            });
            document.getElementById('mat-nome').value='';
            await registrarHistorico(ACAO_ATUAL_ID, `Adicionou material: ${nome}`, "sistema");
            renderMateriais(ACAO_ATUAL_ID);
        }
        async function atualizarDadosPrincipais() {
            if(!ACAO_ATUAL_ID) return;
            const data = { titulo: document.getElementById('edit-titulo').value, descricao: document.getElementById('edit-descricao').value, ordem_servico: document.getElementById('edit-os').value, numero_sc: document.getElementById('edit-sc').value, categoria: document.getElementById('edit-categoria').value, urgencia: document.getElementById('edit-urgencia').value };
            try { await pb.collection('acoes').update(ACAO_ATUAL_ID, data); await registrarHistorico(ACAO_ATUAL_ID, "Dados atualizados", "sistema"); registrarNotificacao("Atualizado!"); if(!document.getElementById('view-manutencao').classList.contains('hidden')) carregarManutencao(); } catch(e) { alert("Erro: " + e.message); }
        }
        async function renderHistorico(id) { const div=document.getElementById('chat-feed'); const logs=await pb.collection('historico').getFullList({filter:`acao_vinculada="${id}"`, sort:'created', expand:'usuario'}); div.innerHTML=''; logs.forEach(l=>{ const isMe=l.expand?.usuario?.id===pb.authStore.model.id; const cls=l.tipo==='sistema'?'chat-sistema':(isMe?'chat-me':'chat-user'); const user=l.expand?.usuario?.name||'Sistema'; const time=new Date(l.created).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}); div.innerHTML+=`<div class="chat-bubble ${cls}">${l.tipo!=='sistema'?`<div class="chat-meta">${user} - ${time}</div>`:''}${l.mensagem}</div>`; }); div.scrollTop=div.scrollHeight; }
        async function enviarComentario() { const msg=document.getElementById('chat-msg').value; if(!msg) return; await registrarHistorico(ACAO_ATUAL_ID, msg, "comentario"); document.getElementById('chat-msg').value=''; renderHistorico(ACAO_ATUAL_ID); }
        async function registrarHistorico(acaoId, msg, tipo) { return await pb.collection('historico').create({ acao_vinculada: acaoId, usuario: pb.authStore.model.id, mensagem: msg, tipo: tipo.toLowerCase() }); }
        function iniciarRealtime() { pb.collection('historico').subscribe('*', function(e) { if(e.action==='create' && e.record.acao_vinculada===ACAO_ATUAL_ID) renderHistorico(ACAO_ATUAL_ID); }); pb.collection('materiais').subscribe('*', function(e) { if(ACAO_ATUAL_ID===e.record.acao_vinculada) renderMateriais(ACAO_ATUAL_ID); }); }
        function registrarNotificacao(msg) { const t=document.createElement('div'); t.className='toast'; t.innerHTML=`${msg}`; document.getElementById('toast-container').appendChild(t); setTimeout(()=>t.remove(),5000); NOTIF_COUNT++; document.getElementById('notif-badge').style.display='block'; document.getElementById('notif-badge').innerText=NOTIF_COUNT; document.getElementById('notif-items-container').innerHTML+=`<div class="notif-item">${msg}<br><span class="notif-time">Agora</span></div>`; }
        function toggleNotificacoes() { const el=document.getElementById('notif-list'); el.style.display=el.style.display==='block'?'none':'block'; if(el.style.display==='block'){NOTIF_COUNT=0; document.getElementById('notif-badge').style.display='none';}}
        function limparNotif(e) { e.stopPropagation(); document.getElementById('notif-items-container').innerHTML=''; }
        function formatDate(d) { if(!d) return '-'; return new Date(d).toLocaleDateString(); }
        async function carregarUsuarios() { const u=await pb.collection('users').getFullList(); const s=document.getElementById('inp-responsavel'); s.innerHTML=''; u.forEach(x=>s.innerHTML+=`<option value="${x.id}">${x.name}</option>`); }
        function abrirModalImportacao() { document.getElementById('modal-importacao').classList.remove('hidden'); document.getElementById('step-upload').classList.remove('hidden'); document.getElementById('step-mapping').classList.add('hidden'); document.getElementById('input-excel').value=''; }
        function fecharModalImportacao() { document.getElementById('modal-importacao').classList.add('hidden'); }
        function lerArquivoExcel(input) { const file=input.files[0]; if(!file) return; const reader=new FileReader(); reader.onload=function(e){ const data=new Uint8Array(e.target.result); const workbook=XLSX.read(data, {type:'array'}); const jsonData=XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header:1}); if(jsonData.length<1) return alert("Vazio!"); IMPORT_DATA=jsonData; prepararMapeamento(jsonData[0]); }; reader.readAsArrayBuffer(file); }
        function prepararMapeamento(headers) { document.getElementById('step-upload').classList.add('hidden'); document.getElementById('step-mapping').classList.remove('hidden'); const s1=document.getElementById('map-desc'); const s2=document.getElementById('map-qtd'); s1.innerHTML=''; s2.innerHTML=''; headers.forEach((h,i)=>{ const o=`<option value="${i}">${h}</option>`; s1.innerHTML+=o; s2.innerHTML+=o; }); }
        async function executarImportacao() { if(!IMPORT_DATA || !ACAO_ATUAL_ID) return; const cD=parseInt(document.getElementById('map-desc').value); const cQ=parseInt(document.getElementById('map-qtd').value); const urg=document.getElementById('map-urg').value; let cnt=0; for(let i=1; i<IMPORT_DATA.length; i++){ const r=IMPORT_DATA[i]; if(r[cD]){ try{ await pb.collection('materiais').create({acao_vinculada:ACAO_ATUAL_ID, descricao:r[cD], quantidade:r[cQ]||1, urgencia_material:urg, status_compra:'Em cota√ß√£o'}); cnt++; }catch(e){} } } alert(`${cnt} importados!`); fecharModalImportacao(); await registrarHistorico(ACAO_ATUAL_ID, `Importou ${cnt} itens`, "sistema"); renderMateriais(ACAO_ATUAL_ID); }

        checkAuth();
    </script>
</body>
</html>